# yaml-language-server: $schema=https://azuremlsdk2.blob.core.windows.net/latest/commandJob.schema.json

# See https://aka.ms/azuremlv2 for more details on how to use this job file.

experiment_name: azuremlv2

# Sadly, have to hard code num_nodes twice :( .
# TODO: is there a way to have single value used in both places?
# TODO: add +trainer.accelerator=ddp for genuinely distributed training.
command: >-
  python train.py
  trainer.gpus=2
  trainer.num_nodes=1
  +trainer.accelerator=ddp

code:
  directory: .

environment:
  name: hydra-pl
  version: 8
  conda_file: environment.yml
  docker:
    image: mcr.microsoft.com/azureml/openmpi3.1.2-cuda10.2-cudnn8-ubuntu18.04


distribution:
  # Good news: it looks like this sets the appropriate environment variables
  # (MASTER_ADDR, MASTER_PORT, NCCL_SOCKET_IFNAME, NODE_RANK).
  type: pytorch
  process_count_per_instance: 1

compute:
  target: azureml:gpu-nc12-lowpri
  node_count: 1

tags:
  from: cliv2
