# yaml-language-server: $schema=https://azuremlsdk2.blob.core.windows.net/latest/commandJob.schema.json

experiment_name: azuremlv2

# TODO: outputs are not supported?

# Sadly, have to hard code num_nodes twice :( .
# TODO: is there a way to have single value used in both places?
# TODO: add +trainer.accelerator=ddp for genuinely distributed training.
command: >-
  python train.py
  trainer.gpus=1
  trainer.num_nodes=1

code:
  directory: .

environment:
  name: hydra-pl
  version: 5
  conda_file: environment.yml
  docker:
    # Something is wrong with CUDNN 8 + CUDA 10.2?
    # https://github.com/tensorflow/tensorflow/issues/40423
    image: mcr.microsoft.com/azureml/openmpi3.1.2-cuda10.2-cudnn7-ubuntu18.04


distribution:
  # Good news: it looks like this sets the appropriate environment variables
  # (MASTER_ADDR, MASTER_PORT, NCCL_SOCKET_IFNAME, NODE_RANK).
  type: pytorch
  process_count_per_instance: 1

compute:
  target: azureml:gpu-nc12-lowpri
  node_count: 1

tags:
  from: cliv2
